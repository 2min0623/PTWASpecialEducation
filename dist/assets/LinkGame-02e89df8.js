import{$ as p}from"./jquery-eebbd0cf.js";import{G as f}from"./get_assets-8814068a.js";import{_,o as w,c as D,a as g,t as m,F as v,p as C,e as W}from"./index-fce9030c.js";async function R(s,t){let e=[];function h(a){return new Promise((r,c)=>{let n=new Image;n.onload=()=>r(n),n.onerror=c,n.src=a})}async function i(a){let r=[];for(let c of a)if(Array.isArray(c))r.push(await i(c));else try{let n=await h(f(t,c));r.push(n)}catch(n){console.error("圖片載入失敗：",n)}return r}return e=await i(s),e}const L={name:"Link",props:{GameData:{type:Object,required:!0},id:{type:String,required:!0},GameConfig:{type:Object,required:!0}},data(){return{WH:null,Canvasoffset:{},Min_border:10,Min_RowGap:30,Min_ImgWidth:300,RWD_Img_Width:null,RWD_Gap_Width:null,TouchSensitive:1,DotRadius:7,isDrawing:!1,paths:[],ontouch_group:0,DotLocation:[],OnclickLocation:[],QuestionDataStructure:null,ans:[[[0,0],[1,0]],[[0,1],[1,2]],[[0,2],[1,1]]],answered:[]}},mounted(){this.QuestionDataStructure=this.GameData.Question.RowData,this.ans=this.GameData.Answer;let s=this.$refs.CanvasContainer;this.Canvasoffset={top:s.offsetTop,left:s.offsetLeft};let t=document.getElementsByTagName("canvas")[0];t.style.top=this.Canvasoffset.top+"px",t.style.left=this.Canvasoffset.left+"px",this.$refs.line_keeper;let e=document.getElementById("line_keeper");e.style.top=this.Canvasoffset.top+"px",e.style.left=this.Canvasoffset.left+"px",this.WH=s.getBoundingClientRect();const h=p("#responsive-bg")[0],i=h.getContext("2d");h.width=this.WH.width,h.height=this.WH.height,i.clearRect(0,0,h.width,h.height);let a=this.CountRWDWidth(this.QuestionDataStructure);this.RWD_Img_Width=a.Img_width,this.RWD_Gap_Width=a.Gap_width,this.DrawImgOnCanvas(this.QuestionDataStructure,i),this.canvas=this.$refs.line_keeper,this.context=this.canvas.getContext("2d"),this.canvas.width=this.WH.width,this.canvas.height=this.WH.height,window.addEventListener("resize",()=>{let r=this.$refs.CanvasContainer;this.Canvasoffset={top:r.offsetTop,left:r.offsetLeft};let c=document.getElementsByTagName("canvas")[0];c.style.top=this.Canvasoffset.top+"px",c.style.left=this.Canvasoffset.left+"px",this.$refs.line_keeper;let n=document.getElementById("line_keeper");n.style.top=this.Canvasoffset.top+"px",n.style.left=this.Canvasoffset.left+"px",this.WH=r.getBoundingClientRect();const u=p("#responsive-bg")[0],o=u.getContext("2d");u.width=this.WH.width,u.height=this.WH.height,o.clearRect(0,0,u.width,u.height);let l=this.CountRWDWidth(this.QuestionDataStructure);this.RWD_Img_Width=l.Img_width,this.RWD_Gap_Width=l.Gap_width,this.DrawImgOnCanvas(this.QuestionDataStructure,o),this.canvas=this.$refs.line_keeper,this.context=this.canvas.getContext("2d"),this.canvas.width=this.WH.width,this.canvas.height=this.WH.height,this.MapTransfer()}),this.Runtimes=0,this.TotalAmount=this.ans.length,this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mouseup",this.handleMouseUp),this.canvas.addEventListener("touchstart",this.handleTouchStart),this.canvas.addEventListener("touchmove",this.handleTouchMove),this.canvas.addEventListener("touchend",this.handleTouchEnd)},methods:{CountRWDWidth(s){let t=s.length,e=parseInt((this.WH.width-this.Min_border*2)/(t*2+(t-1)*3));return{Img_width:e*2,Gap_width:e*3}},CountMaxImgSize(s){let t=(this.WH.height-this.Min_border*2)/s,e=this.RWD_Img_Width;return{Max_Height:t,Max_Width:e}},ResizeRWDImg(s,t){let e,h,i=t.height/t.width;return e=s.Max_Height,h=s.Max_Height/i,h>s.Max_Width&&(h=s.Max_Width,e=s.Max_Width*i),{New_Height:e,New_Width:h}},CountRWDYGap(s){let t=0,e=this.CountMaxImgSize(s.length);for(var h in s){let i=new Image;i.src=f(this.id,s[h]);let a=this.ResizeRWDImg(e,i);t+=a.New_Height}return(this.WH.height-this.Min_border*2-t)/(s.length+1)},FindDotXY(s,t){for(var e in this.DotLocation)if(this.DotLocation[e][0][0]==t&&this.DotLocation[e][0][1]==s)return{x:this.DotLocation[e][1][0],y:this.DotLocation[e][1][1]}},MapTransfer(){let s=[];for(var t in this.answered){let e=this.FindDotXY(this.answered[t][0][0],this.answered[t][0][1]),h=this.FindDotXY(this.answered[t][1][0],this.answered[t][1][1]);s.push({startX:e.x,startY:e.y,currentX:h.x,currentY:h.y})}this.paths=s,this.drawPaths()},async DrawImgOnCanvas(s,t){let e=await R(s,this.id);console.log(e);let h=s.length,i=0;this.Group=1,this.DotLocation=[];for(let a=0;a<s.length;a++){const r=this.CountMaxImgSize(this.QuestionDataStructure[a].length);let c=this.CountRWDYGap(s[a]);for(let n=0;n<s[a].length;n++){let u=e[a][n],o=this.ResizeRWDImg(r,u),l=this.Min_border+r.Max_Width*a+this.RWD_Gap_Width*a,d=this.Min_border+c+r.Max_Height*n;t.drawImage(u,l,d,o.New_Width,o.New_Height),t.beginPath(),a==0?(t.arc(l+o.New_Width+this.Min_border,d+o.New_Height/2,this.DotRadius,0,Math.PI*2,!0),this.DotLocation.push([[n,i,this.Group],[l+o.New_Width+this.Min_border,d+o.New_Height/2]]),t.fillStyle="black",t.fill()):a==h-1?(t.arc(l-this.Min_border,d+o.New_Height/2,this.DotRadius,0,Math.PI*2,!0),this.DotLocation.push([[n,i,this.Group],[l-this.Min_border,d+o.New_Height/2]]),t.fillStyle="black",t.fill()):(t.arc(l+o.New_Width+this.Min_border,d+o.New_Height/2,this.DotRadius,0,Math.PI*2,!0),this.DotLocation.push([[n,i+1,this.Group+1],[l+o.New_Width+this.Min_border,d+o.New_Height/2]]),t.arc(l-this.Min_border,d+o.New_Height/2,this.DotRadius,0,Math.PI*2,!0),this.DotLocation.push([[n,i,this.Group],[l-this.Min_border,d+o.New_Height/2]]),t.fillStyle="black",t.fill()),t.closePath()}i+=1,a!=0&&(this.Group++,i+=1)}},getEventPos(s){const t=this.canvas.getBoundingClientRect();return{x:s.clientX-t.left,y:s.clientY-t.top}},handleMouseDown(s){const t=this.getEventPos(s);var e=this.JudgeRange(t.x,t.y);this.column=e.ColumnID,this.ontouch_group=e.Group,e.Locate&&(this.isDrawing||(this.isDrawing=!0,this.paths.push({startX:t.x,startY:t.y}),this.OnclickLocation=[e.ColumnID,e.RowID]))},handleMouseMove(s){if(this.isDrawing){const t=this.getEventPos(s);this.paths[this.paths.length-1].currentX=t.x,this.paths[this.paths.length-1].currentY=t.y,this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawPaths()}},handleMouseUp(s){console.log(this.isDrawing);const t=this.getEventPos(s);var e=this.JudgeRange(t.x,t.y),h=this.JudgeAnswered(this.OnclickLocation[0],this.OnclickLocation[1],e.ColumnID,e.RowID);if(h)this.isDrawing=!1,this.isDrawing&&this.clearLastPath();else{var i=this.CheckAnswer(this.OnclickLocation[0],this.OnclickLocation[1],e.ColumnID,e.RowID);e.Locate&&this.ontouch_group==e.Group&&this.column!=e.ColumnID&&i?(this.isDrawing&&(this.isDrawing=!1,this.paths[this.paths.length-1].endX=t.x,this.paths[this.paths.length-1].endY=t.y,this.drawPaths()),this.ontouch_group=0):(this.isDrawing&&this.clearLastPath(),this.isDrawing=!1)}},handleTouchStart(s){const t=this.getEventPos(s.touches[0]);var e=this.JudgeRange(t.x,t.y);this.column=e.ColumnID,this.ontouch_group=e.Group,e.Locate&&(s.preventDefault(),this.isDrawing=!0,this.paths.push({startX:t.x,startY:t.y}),this.OnclickLocation=[e.ColumnID,e.RowID])},handleTouchMove(s){if(this.isDrawing){s.preventDefault();const t=this.getEventPos(s.touches[0]);this.paths[this.paths.length-1].currentX=t.x,this.paths[this.paths.length-1].currentY=t.y,this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawPaths()}},handleTouchEnd(s){console.log(this.isDrawing);const t=this.getEventPos(s.changedTouches[0]);var e=this.JudgeRange(t.x,t.y),h=this.JudgeAnswered(this.OnclickLocation[0],this.OnclickLocation[1],e.ColumnID,e.RowID);if(h)this.isDrawing=!1,this.isDrawing&&this.clearLastPath();else{var i=this.CheckAnswer(this.OnclickLocation[0],this.OnclickLocation[1],e.ColumnID,e.RowID);e.Locate&&this.ontouch_group==e.Group&&this.column!=e.ColumnID&&i&&!h?this.isDrawing&&(s.preventDefault(),this.isDrawing=!1,this.paths[this.paths.length-1].endX=t.x,this.paths[this.paths.length-1].endY=t.y,this.drawPaths(),this.ontouch_group=0):(this.isDrawing=!1,this.isDrawing&&this.clearLastPath())}},drawPaths(){this.paths.forEach(s=>{this.context.beginPath(),this.context.moveTo(s.startX,s.startY),this.context.lineTo(s.currentX,s.currentY),this.context.stroke(),this.context.closePath()})},clearLastPath(){this.paths.pop(),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawPaths()},JudgeRange(s,t){for(var e=0;e<this.DotLocation.length;e++)if(length=((this.DotLocation[e][1][0]-s)**2+(this.DotLocation[e][1][1]-t)**2)**.5,length<=this.DotRadius)return{Locate:!0,Group:this.DotLocation[e][0][2],RowID:this.DotLocation[e][0][0],ColumnID:this.DotLocation[e][0][1]};return{Locate:!1,Group:void 0}},JudgeAnswered(s,t,e,h){for(var i in this.answered){if(this.answered[i][0][0]==s&&this.answered[i][0][1]==t&&this.answered[i][1][0]==e&&this.answered[i][1][1]==h)return!0;if(this.answered[i][0][0]==e&&this.answered[i][0][1]==h&&this.answered[i][1][0]==s&&this.answered[i][1][1]==t)return!0}return!1},CheckAnswer(s,t,e,h){let i=!1;for(var a in this.ans)this.ans[a][0][0]==s&&this.ans[a][0][1]==t&&this.ans[a][1][0]==e&&this.ans[a][1][1]==h?(i=!0,this.answered.push(this.ans[a])):this.ans[a][0][0]==e&&this.ans[a][0][1]==h&&this.ans[a][1][0]==s&&this.ans[a][1][1]==t&&(i=!0,this.answered.push(this.ans[a]));return i?(console.log("Link Template Return Correct"),this.Runtimes=this.Runtimes+1,this.Runtimes==this.TotalAmount?(this.GameOver(),this.$emit("add-record",[[[s,t],[e,h]],this.ans[a],"正確"])):(this.$emit("play-effect","CorrectSound"),this.$emit("add-record",[[[s,t],[e,h]],this.ans[a],"正確"])),!0):(console.log("Link Template Return Wrong"),this.$emit("play-effect","WrongSound"),this.$emit("add-record",[[[s,t],[e,h]],this.ans[a],"錯誤"]),!1)},GameOver(){console.log("Component 'Link' post GameOver,All Answer Right"),this.$emit("play-effect","CorrectSound"),this.$emit("add-record",["","","全對"]),this.$emit("next-question")}}},I=s=>(C("data-v-9889aa4f"),s=s(),W(),s),y={class:"h1"},x={class:"canvas-container",id:"canvas-container",ref:"CanvasContainer"},M=I(()=>g("canvas",{id:"responsive-bg",class:"position-absolute"},null,-1)),k={ref:"line_keeper",id:"line_keeper",class:"position-absolute"};function G(s,t,e,h,i,a){return w(),D(v,null,[g("p",y,m(e.GameData.Question.text),1),g("div",x,[M,g("canvas",k,null,512)],512)],64)}const b=_(L,[["render",G],["__scopeId","data-v-9889aa4f"]]);export{b as default};
