import{$ as f}from"./jquery-84c10265.js";import{G as _}from"./get_assets-ed6c2078.js";import{_ as D}from"./_plugin-vue_export-helper-c27b6911.js";import{o as w,c as m,a as g,t as v,F as C,p as R,e as I}from"./index-4d742f7d.js";const L={name:"Link",props:{GameData:{type:Object,required:!0},id:{type:String,required:!0},GameConfig:{type:Object,required:!0}},data(){return{WH:null,Canvasoffset:{},previousinfo:{},Min_border:10,Min_RowGap:30,Min_ImgWidth:300,RWD_Img_Width:null,RWD_Gap_Width:null,TouchSensitive:1,DotRadius:7,isDrawing:!1,paths:[],ontouch_group:0,DotLocation:[],OnclickLocation:[],QuestionDataStructure:null,ans:[[[0,0],[1,0]],[[0,1],[1,2]],[[0,2],[1,1]]],answered:[]}},mounted(){this.QuestionDataStructure=this.GameData.Question.RowData,this.ans=this.GameData.Answer;let s=this.$refs.CanvasContainer;this.Canvasoffset={top:s.offsetTop,left:s.offsetLeft};let t=document.getElementsByTagName("canvas")[0];t.style.top=this.Canvasoffset.top+"px",t.style.left=this.Canvasoffset.left+"px",this.$refs.line_keeper;let e=document.getElementById("line_keeper");e.style.top=this.Canvasoffset.top+"px",e.style.left=this.Canvasoffset.left+"px";let a=s.getBoundingClientRect();this.WH=a,this.previousinfo=a;const i=f("#responsive-bg")[0],h=i.getContext("2d");i.width=a.width,i.height=a.height,h.clearRect(0,0,i.width,i.height);let o=this.CountRWDWidth(this.QuestionDataStructure);this.RWD_Img_Width=o.Img_width,this.RWD_Gap_Width=o.Gap_width,this.DrawImgOnCanvas(this.QuestionDataStructure,h),this.canvas=this.$refs.line_keeper,this.context=this.canvas.getContext("2d"),this.canvas.width=a.width,this.canvas.height=a.height,window.addEventListener("resize",()=>{let d=this.$refs.CanvasContainer;this.Canvasoffset={top:d.offsetTop,left:d.offsetLeft};let c=document.getElementsByTagName("canvas")[0];c.style.top=this.Canvasoffset.top+"px",c.style.left=this.Canvasoffset.left+"px",this.$refs.line_keeper;let u=document.getElementById("line_keeper");u.style.top=this.Canvasoffset.top+"px",u.style.left=this.Canvasoffset.left+"px";let n=d.getBoundingClientRect();this.WH=n,this.previousinfo=n;const r=f("#responsive-bg")[0],l=r.getContext("2d");r.width=n.width,r.height=n.height,l.clearRect(0,0,r.width,r.height);let p=this.CountRWDWidth(this.QuestionDataStructure);this.RWD_Img_Width=p.Img_width,this.RWD_Gap_Width=p.Gap_width,this.DrawImgOnCanvas(this.QuestionDataStructure,l),this.canvas=this.$refs.line_keeper,this.context=this.canvas.getContext("2d"),this.canvas.width=n.width,this.canvas.height=n.height,this.MapTransfer()}),this.Runtimes=0,this.TotalAmount=this.ans.length,this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mouseup",this.handleMouseUp),this.canvas.addEventListener("touchstart",this.handleTouchStart),this.canvas.addEventListener("touchmove",this.handleTouchMove),this.canvas.addEventListener("touchend",this.handleTouchEnd)},methods:{CountRWDWidth(s){let t=s.length,e=parseInt((this.WH.width-this.Min_border*2)/(t*2+(t-1)*3));return{Img_width:e*2,Gap_width:e*3}},CountMaxImgSize(s){let t=(this.WH.height-this.Min_border*2)/s,e=this.RWD_Img_Width;return{Max_Height:t,Max_Width:e}},ResizeRWDImg(s,t){let e,a,i=t.height/t.width;return e=s.Max_Height,a=s.Max_Height/i,a>s.Max_Width&&(a=s.Max_Width,e=s.Max_Width*i),{New_Height:e,New_Width:a}},CountRWDYGap(s){let t=0,e=this.CountMaxImgSize(s.length);for(var a in s){let i=new Image;i.src=_(this.id,s[a]);let h=this.ResizeRWDImg(e,i);t+=h.New_Height}return(this.WH.height-this.Min_border*2-t)/(s.length+1)},async ImageQuery(s){let t=[];function e(a){return new Promise((i,h)=>{let o=new Image;o.onload=()=>i(o),o.onerror=h,o.src=a})}for(let a=0;a<s.length;a++){let i=[];for(let h=0;h<s[a].length;h++)try{let o=await e(_(this.id,s[a][h]));i.push(o)}catch(o){console.error("圖片載入失敗：",o)}t.push(i)}return t},FindDotXY(s,t){for(var e in this.DotLocation)if(this.DotLocation[e][0][0]==t&&this.DotLocation[e][0][1]==s)return{x:this.DotLocation[e][1][0],y:this.DotLocation[e][1][1]}},MapTransfer(){let s=[];for(var t in this.answered){let e=this.FindDotXY(this.answered[t][0][0],this.answered[t][0][1]),a=this.FindDotXY(this.answered[t][1][0],this.answered[t][1][1]);s.push({startX:e.x,startY:e.y,currentX:a.x,currentY:a.y})}this.paths=s,this.drawPaths()},async DrawImgOnCanvas(s,t){let e=await this.ImageQuery(s);console.log(e);let a=s.length,i=0;this.Group=1,this.DotLocation=[];for(let h=0;h<s.length;h++){const o=this.CountMaxImgSize(this.QuestionDataStructure[h].length);let d=this.CountRWDYGap(s[h]);for(let c=0;c<s[h].length;c++){let u=e[h][c],n=this.ResizeRWDImg(o,u),r=this.Min_border+o.Max_Width*h+this.RWD_Gap_Width*h,l=this.Min_border+d+o.Max_Height*c;t.drawImage(u,r,l,n.New_Width,n.New_Height),t.beginPath(),h==0?(t.arc(r+n.New_Width+this.Min_border,l+n.New_Height/2,this.DotRadius,0,Math.PI*2,!0),this.DotLocation.push([[c,i,this.Group],[r+n.New_Width+this.Min_border,l+n.New_Height/2]]),t.fillStyle="black",t.fill()):h==a-1?(t.arc(r-this.Min_border,l+n.New_Height/2,this.DotRadius,0,Math.PI*2,!0),this.DotLocation.push([[c,i,this.Group],[r-this.Min_border,l+n.New_Height/2]]),t.fillStyle="black",t.fill()):(t.arc(r+n.New_Width+this.Min_border,l+n.New_Height/2,this.DotRadius,0,Math.PI*2,!0),this.DotLocation.push([[c,i+1,this.Group+1],[r+n.New_Width+this.Min_border,l+n.New_Height/2]]),t.arc(r-this.Min_border,l+n.New_Height/2,this.DotRadius,0,Math.PI*2,!0),this.DotLocation.push([[c,i,this.Group],[r-this.Min_border,l+n.New_Height/2]]),t.fillStyle="black",t.fill()),t.closePath()}i+=1,h!=0&&(this.Group++,i+=1)}},getEventPos(s){const t=this.canvas.getBoundingClientRect();return{x:s.clientX-t.left,y:s.clientY-t.top}},handleMouseDown(s){const t=this.getEventPos(s);var e=this.JudgeRange(t.x,t.y);this.column=e.ColumnID,this.ontouch_group=e.Group,e.Locate&&(this.isDrawing||(this.isDrawing=!0,this.paths.push({startX:t.x,startY:t.y}),this.OnclickLocation=[e.ColumnID,e.RowID]))},handleMouseMove(s){if(this.isDrawing){const t=this.getEventPos(s);this.paths[this.paths.length-1].currentX=t.x,this.paths[this.paths.length-1].currentY=t.y,this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawPaths()}},handleMouseUp(s){console.log(this.isDrawing);const t=this.getEventPos(s);var e=this.JudgeRange(t.x,t.y),a=this.JudgeAnswered(this.OnclickLocation[0],this.OnclickLocation[1],e.ColumnID,e.RowID);if(a)this.isDrawing=!1,this.isDrawing&&this.clearLastPath();else{var i=this.CheckAnswer(this.OnclickLocation[0],this.OnclickLocation[1],e.ColumnID,e.RowID);e.Locate&&this.ontouch_group==e.Group&&this.column!=e.ColumnID&&i?(this.isDrawing&&(this.isDrawing=!1,this.paths[this.paths.length-1].endX=t.x,this.paths[this.paths.length-1].endY=t.y,this.drawPaths()),this.ontouch_group=0):(this.isDrawing&&this.clearLastPath(),this.isDrawing=!1)}},handleTouchStart(s){const t=this.getEventPos(s.touches[0]);var e=this.JudgeRange(t.x,t.y);this.column=e.ColumnID,this.ontouch_group=e.Group,e.Locate&&(s.preventDefault(),this.isDrawing=!0,this.paths.push({startX:t.x,startY:t.y}),this.OnclickLocation=[e.ColumnID,e.RowID])},handleTouchMove(s){if(this.isDrawing){s.preventDefault();const t=this.getEventPos(s.touches[0]);this.paths[this.paths.length-1].currentX=t.x,this.paths[this.paths.length-1].currentY=t.y,this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawPaths()}},handleTouchEnd(s){console.log(this.isDrawing);const t=this.getEventPos(s.changedTouches[0]);var e=this.JudgeRange(t.x,t.y),a=this.JudgeAnswered(this.OnclickLocation[0],this.OnclickLocation[1],e.ColumnID,e.RowID);if(a)this.isDrawing=!1,this.isDrawing&&this.clearLastPath();else{var i=this.CheckAnswer(this.OnclickLocation[0],this.OnclickLocation[1],e.ColumnID,e.RowID);e.Locate&&this.ontouch_group==e.Group&&this.column!=e.ColumnID&&i&&!a?this.isDrawing&&(s.preventDefault(),this.isDrawing=!1,this.paths[this.paths.length-1].endX=t.x,this.paths[this.paths.length-1].endY=t.y,this.drawPaths(),this.ontouch_group=0):(this.isDrawing=!1,this.isDrawing&&this.clearLastPath())}},drawPaths(){this.paths.forEach(s=>{this.context.beginPath(),this.context.moveTo(s.startX,s.startY),this.context.lineTo(s.currentX,s.currentY),this.context.stroke(),this.context.closePath()})},clearLastPath(){this.paths.pop(),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawPaths()},JudgeRange(s,t){for(var e=0;e<this.DotLocation.length;e++)if(length=((this.DotLocation[e][1][0]-s)**2+(this.DotLocation[e][1][1]-t)**2)**.5,length<=this.DotRadius)return{Locate:!0,Group:this.DotLocation[e][0][2],RowID:this.DotLocation[e][0][0],ColumnID:this.DotLocation[e][0][1]};return{Locate:!1,Group:void 0}},JudgeAnswered(s,t,e,a){for(var i in this.answered){if(this.answered[i][0][0]==s&&this.answered[i][0][1]==t&&this.answered[i][1][0]==e&&this.answered[i][1][1]==a)return!0;if(this.answered[i][0][0]==e&&this.answered[i][0][1]==a&&this.answered[i][1][0]==s&&this.answered[i][1][1]==t)return!0}return!1},CheckAnswer(s,t,e,a){let i=!1;for(var h in this.ans)this.ans[h][0][0]==s&&this.ans[h][0][1]==t&&this.ans[h][1][0]==e&&this.ans[h][1][1]==a?(i=!0,this.answered.push(this.ans[h])):this.ans[h][0][0]==e&&this.ans[h][0][1]==a&&this.ans[h][1][0]==s&&this.ans[h][1][1]==t&&(i=!0,this.answered.push(this.ans[h]));return i?(console.log("Link Template Return Correct"),this.Runtimes=this.Runtimes+1,this.Runtimes==this.TotalAmount?(this.GameOver(),this.$emit("add-record",[[[s,t],[e,a]],this.ans[h],"正確"])):(this.$emit("play-effect","CorrectSound"),this.$emit("add-record",[[[s,t],[e,a]],this.ans[h],"正確"])),!0):(console.log("Link Template Return Wrong"),this.$emit("play-effect","WrongSound"),this.$emit("add-record",[[[s,t],[e,a]],this.ans[h],"錯誤"]),!1)},GameOver(){console.log("Component 'Link' post GameOver,All Answer Right"),this.$emit("play-effect","CorrectSound"),this.$emit("add-record",["","","全對"]),this.$emit("next-question")}}},W=s=>(R("data-v-97c3a6ba"),s=s(),I(),s),y={class:"h1"},x={class:"canvas-container",ref:"CanvasContainer"},M=W(()=>g("canvas",{id:"responsive-bg",class:"position-absolute",style:{border:"solid"}},null,-1)),k={ref:"line_keeper",id:"line_keeper",class:"position-absolute",style:{border:"solid"}};function G(s,t,e,a,i,h){return w(),m(C,null,[g("p",y,v(e.GameData.Question.text),1),g("div",x,[M,g("canvas",k,null,512)],512)],64)}const E=D(L,[["render",G],["__scopeId","data-v-97c3a6ba"]]);export{E as default};
